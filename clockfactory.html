<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clock Factory Tycoon</title>
  <style>
    body {
      margin: 0;
      display: flex;
      font-family: sans-serif;
      background-color: #121212;
      color: white;
      height: 100vh;
      overflow: hidden;
    }

    #game {
      display: grid;
      grid-template-columns: repeat(16, 40px);
      grid-template-rows: repeat(16, 40px);
      gap: 1px;
      background-color: #333;
      margin: 20px;
      position: relative;
      flex-shrink: 0;
    }

    .cell {
      width: 40px;
      height: 40px;
      background-color: #1e1e1e;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      border: 1px solid #444;
      position: relative;
      user-select: none;
    }

    .factory {
      background-color: #4caf50;
    }

    .sell {
      background-color: #2196f3;
    }

    .arrow {
      transform: rotate(0deg);
      transition: transform 0.2s;
      font-weight: bold;
      font-size: 20px;
      user-select: none;
    }

    .clock {
      width: 20px;
      height: 20px;
      background-color: yellow;
      border-radius: 50%;
      position: absolute;
      pointer-events: none;
    }

    .block {
      background-color: orange;
      font-weight: bold;
      user-select: none;
    }

    #sidebar {
      width: 300px;
      padding: 20px;
      background-color: #1e1e2f;
      display: flex;
      flex-direction: column;
      gap: 15px;
      box-sizing: border-box;
      user-select: none;
    }

    button {
      padding: 10px;
      background-color: #4caf50;
      border: none;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      user-select: none;
    }

    button:hover {
      background-color: #45a049;
    }

    .selected {
      outline: 2px solid yellow;
      box-sizing: border-box;
    }

    h2 {
      margin-top: 0;
      margin-bottom: 10px;
    }

    a.button-link {
      text-decoration: none;
      display: inline-block;
      padding: 10px;
      background-color: #2196f3;
      border-radius: 5px;
      color: white;
      text-align: center;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
    }

    a.button-link:hover {
      background-color: #1976d2;
    }
  </style>
</head>
<body>
  <div id="game"></div>
  <div id="sidebar">
    <h2>Shop</h2>
    <button onclick="buyBlock('+2')">+2 Block (â‚¬<span id="costPlus2">100</span>)</button>
    <button onclick="buyBlock('x2')">x2 Block (â‚¬<span id="costX2">200</span>)</button>
    <button onclick="buyBlock('bocht')">Bocht (â‚¬500)</button>

    <p>Money: â‚¬<span id="money">0</span></p>

    <button onclick="saveGame()">Opslaan</button>
    <button onclick="loadGame()">Laden</button>

    <a href="index.html" class="button-link" style="margin-top: 20px;">Back to Homepage</a>
  </div>

  <script>
    const game = document.getElementById("game");
    const size = 16;
    const grid = [];
    const clocks = [];
    let selected = null;
    let money = 0;

    let costPlus2 = 100;
    let costX2 = 200;

    const blocks = [];

    const factory = { x: 5, y: 5, type: "factory", rotation: 0 };
    const sell = { x: 10, y: 10, type: "sell", rotation: 0 };

    const directionFromRotation = (rotation) => {
      const deg = rotation % 360;
      if (deg === 0) return [1, 0];
      if (deg === 90) return [0, 1];
      if (deg === 180) return [-1, 0];
      if (deg === 270) return [0, -1];
      return [0, 0];
    };

    function createGrid() {
      game.innerHTML = "";
      for (let y = 0; y < size; y++) {
        grid[y] = [];
        for (let x = 0; x < size; x++) {
          const cell = document.createElement("div");
          cell.classList.add("cell");
          cell.dataset.x = x;
          cell.dataset.y = y;

          if (x === factory.x && y === factory.y) {
            cell.classList.add("factory");
            cell.innerHTML = `<span class="arrow">â†’</span>`;
            cell.querySelector(".arrow").style.transform = `rotate(${factory.rotation}deg)`;
            if (selected === factory) cell.classList.add("selected");
          } else if (x === sell.x && y === sell.y) {
            cell.classList.add("sell");
            cell.innerHTML = "SELL";
            if (selected === sell) cell.classList.add("selected");
          } else {
            const block = blocks.find(b => b.x === x && b.y === y);
            if (block) {
              cell.classList.add("block");
              cell.textContent = block.type;
              if (selected === block) cell.classList.add("selected");
            }
          }

          cell.addEventListener("click", () => {
            if (selected) {
              // Verplaats het geselecteerde object
              // Zorg dat de plek vrij is (behalve de plek waar het stond)
              if (!isOccupied(x, y) || isSamePosition(selected, x, y)) {
                selected.x = x;
                selected.y = y;
                selected = null;
              } else {
                alert("Deze plek is al bezet!");
              }
            } else {
              if (x === factory.x && y === factory.y) selected = factory;
              else if (x === sell.x && y === sell.y) selected = sell;
              else {
                const block = blocks.find(b => b.x === x && b.y === y);
                if (block) selected = block;
              }
            }
            createGrid();
          });

          grid[y][x] = cell;
          game.appendChild(cell);
        }
      }
    }

    function isOccupied(x, y) {
      if ((factory.x === x && factory.y === y) || (sell.x === x && sell.y === y)) return true;
      return blocks.some(b => b.x === x && b.y === y);
    }

    function isSamePosition(obj, x, y) {
      return obj.x === x && obj.y === y;
    }

    document.addEventListener("keydown", (e) => {
      if (e.key === "r" && selected) {
        selected.rotation = (selected.rotation + 90) % 360;
        createGrid();
      }
    });

    function spawnClock() {
      const [dx, dy] = directionFromRotation(factory.rotation);
      const cx = factory.x + dx;
      const cy = factory.y + dy;

      if (cx >= 0 && cx < size && cy >= 0 && cy < size) {
        clocks.push({ x: cx, y: cy, dx, dy, value: 1 });
      }
    }

    function updateClocks() {
      for (let i = clocks.length - 1; i >= 0; i--) {
        const clock = clocks[i];

        const block = blocks.find(b => b.x === clock.x && b.y === clock.y);
        if (block && block.type === "bocht") {
          const [dx, dy] = [clock.dx, clock.dy];
          // Draai de richting 90 graden rechtsom
          if (dx === 1 && dy === 0) [clock.dx, clock.dy] = [0, 1];
          else if (dx === 0 && dy === 1) [clock.dx, clock.dy] = [-1, 0];
          else if (dx === -1 && dy === 0) [clock.dx, clock.dy] = [0, -1];
          else if (dx === 0 && dy === -1) [clock.dx, clock.dy] = [1, 0];
        }

        clock.x += clock.dx;
        clock.y += clock.dy;

        if (block) {
          if (block.type === "+2") clock.value += 2;
          else if (block.type === "x2") clock.value *= 2;
        }

        if (clock.x === sell.x && clock.y === sell.y) {
          money += clock.value;
          document.getElementById("money").textContent = money;
          clocks.splice(i, 1);
        } else if (
          clock.x < 0 || clock.x >= size ||
          clock.y < 0 || clock.y >= size
        ) {
          clocks.splice(i, 1);
        }
      }
    }

    function drawClocks() {
      // Verwijder eerst alle clock elementen
      document.querySelectorAll(".clock").forEach(c => c.remove());

      clocks.forEach(clock => {
        const cell = grid[clock.y][clock.x];
        if (!cell) return;
        const clockEl = document.createElement("div");
        clockEl.classList.add("clock");
        clockEl.textContent = "ðŸ•’";
        // Plaats in de cel, centeren met absolute posities
        const rect = cell.getBoundingClientRect();
        const gameRect = game.getBoundingClientRect();
        clockEl.style.left = (cell.offsetLeft + 10) + "px";
        clockEl.style.top = (cell.offsetTop + 10) + "px";
        game.appendChild(clockEl);
      });
    }

    function gameLoop() {
      spawnClock();
      updateClocks();
      drawClocks();
    }

    setInterval(gameLoop, 1000);

    function buyBlock(type) {
      if (type === "+2") {
        if (money >= costPlus2) {
          // Voeg +2 block toe naast factory als mogelijk
          const pos = findFreeSpot();
          if (!pos) return alert("Geen vrije plek om +2 block te plaatsen!");
          blocks.push({ x: pos.x, y: pos.y, type: "+2", rotation: 0 });
          money -= costPlus2;
          costPlus2 = Math.floor(costPlus2 * 1.5);
          document.getElementById("costPlus2").textContent = costPlus2;
        } else {
          alert("Niet genoeg geld!");
        }
      } else if (type === "x2") {
        if (money >= costX2) {
          const pos = findFreeSpot();
          if (!pos) return alert("Geen vrije plek om x2 block te plaatsen!");
          blocks.push({ x: pos.x, y: pos.y, type: "x2", rotation: 0 });
          money -= costX2;
          costX2 = Math.floor(costX2 * 1.5);
          document.getElementById("costX2").textContent = costX2;
        } else {
          alert("Niet genoeg geld!");
        }
      } else if (type === "bocht") {
        if (money >= 500) {
          const pos = findFreeSpot();
          if (!pos) return alert("Geen vrije plek om bocht te plaatsen!");
          blocks.push({ x: pos.x, y: pos.y, type: "bocht", rotation: 0 });
          money -= 500;
        } else {
          alert("Niet genoeg geld!");
        }
      }
      document.getElementById("money").textContent = money;
      createGrid();
    }

    function findFreeSpot() {
      // Zoek eerste vrije plek naast factory
      for (let y = 0; y < size; y++) {
        for (let x = 0; x < size; x++) {
          if (!isOccupied(x, y)) return { x, y };
        }
      }
      return null;
    }

    function saveGame() {
      const saveData = {
        money,
        blocks,
        factory,
        sell,
        costPlus2,
        costX2
      };
      localStorage.setItem('clockFactorySave', JSON.stringify(saveData));
      alert("Game opgeslagen!");
    }

    function loadGame() {
      const saveData = JSON.parse(localStorage.getItem('clockFactorySave'));
      if (saveData) {
        money = saveData.money || 0;
        blocks.length = 0;
        saveData.blocks.forEach(b => blocks.push(b));
        factory.x = saveData.factory.x;
        factory.y = saveData.factory.y;
        factory.rotation = saveData.factory.rotation;
        sell.x = saveData.sell.x;
        sell.y = saveData.sell.y;
        sell.rotation = saveData.sell.rotation;
        costPlus2 = saveData.costPlus2 ?? 100;
        costX2 = saveData.costX2 ?? 200;

        document.getElementById("money").textContent = money;
        document.getElementById("costPlus2").textContent = costPlus2;
        document.getElementById("costX2").textContent = costX2;

        selected = null;
        createGrid();
        alert("Game geladen!");
      } else {
        alert("Geen opgeslagen spel gevonden.");
      }
    }

    createGrid();

    // Update prijzen en geld bij start
    document.getElementById("money").textContent = money;
    document.getElementById("costPlus2").textContent = costPlus2;
    document.getElementById("costX2").textContent = costX2;
  </script>
</body>
</html>
